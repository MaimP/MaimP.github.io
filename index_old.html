<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <title>Cryptocurrencie analysing</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.stock.min.js"></script>
  <script src="https://unpkg.com/vue@next"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">
  <script src="main.js"></script>
  <script type="text/javascript">

    var DataPoints = [];
    var sorted_ids = [];

    var db = new PouchDB('http://admin:0000@192.168.178.41:5984/crypto');
    console.log("main.js running ")
    // This assumes you have created your find index and seeded your initial documents.
    // Start our live query
    var changes = db.changes({
      since: 'now',
      live: true,
      include_docs: true
    }).on('change', function(change) {
      // handle change
      console.log("change");
      console.log(change)
      searchForChart(change)

    }).on('complete', function(info) {
      // changes() was canceled
      console.log("complete");
    }).on('error', function (err) {
      console.log("error");
      console.log(err);
    });

    function updateChartData(change) {
      var changedId = change.id
      if (checkExist(changedId)) {
        //Cahrt exists, have to update chart (vue.js)
      }
      chart.render(change, changedId)
    }

    function searchForChart(data) {
        var chart_id;
        var name_search = data.id
        for (let i in DataPoint_header) {
          if (name_search == i) {
              chart_id = i.name_search;
              console.log('chart_id gefunden, id ist: ${chart_id}');
              //chart existiert
              return true
          }
        }
        //chart existiert nicht
        return false
      }

    async function getIds() {
      var counter = 0;
      let doc = await db.get('ids');
      for (let a in doc) {
        if (counter >= 2) {
          sorted_ids.push(doc[a])
        }
        counter += 1;
      }
      sorted_ids.sort();
    }

    async function getDataPoints(id) {
      let imp = await db.get(id);
      var name = id;
      var dict;
      var label;
      var x;
      var y;
      var counter = 0;
      for (let a in imp) {
        if (counter >= 10) {
          var doc_price_obj = imp[a];
          console.log(a);
          var date_time = moment(a).format('YYYY-MM-DD HH:mm:ss');
          console.log(data_time);
          var doc_price = doc_price_obj.price;
          dict = {x: new Date(a), y: doc_price};
          DataPoints.push(dict);
        }
        counter += 1;
      }
    }

    //schreibt alle html ids, des Objektes in das Array, um später alle zu finden
    var DataPoint_header = {};
    var chart0;
    var chart1;
    function makeChart(id, chart_obj) {
      db.get(id).then(function (imp) {
        var name = id;
        var dict;
        var label;
        var x;
        var y;
        var counter = 0;
        //for DataPoint_header when change in db
        if(typeof(DataPoint_header) === 'object'){
          var idChart;
          if(JSON.stringify(DataPoint_header) === '{}' || JSON.stringify(DataPoint_header) === '[]'){
            if (chart_obj == "chartContainer0") {
              idChart = "chart0";
            } else {
              idChart = "chart1";
            }
            console.log(idChart)
            DataPoint_header[name] = {idChart: chart_obj}
          } else {
            for (let m in DataPoint_header) {
              console.log("test loop")
              console.log(m)
              if (name != m) {
                if (chart_obj == "chartContainer0") {
                  idChart = "chart0";
                } else {
                  idChart = "chart1";
                }
                //write id of currency, id of chart and html id in array
                DataPoint_header[name] = {idChart: chart_obj};
                console.log(DataPoint_header)
              }
            }
          }
        }
        console.log(DataPoint_header)
        for (let a in imp) {
          //ersten paar Daten sind trash
          if (counter >= 10) {
            //speichere Preis Obj in var
            var doc_price_obj = imp[a];
            //change time format
            var date_time = moment(a).format('YYYY-MM-DD HH:mm:ss');
            //save price in var
            var doc_price = doc_price_obj.price;
            //safe for canvas format chart
            dict = {x: new Date(a), y: doc_price};
            DataPoints.push(dict);
          }
          counter += 1;
        }
      }).then( function () {
            idChart = new CanvasJS.Chart(chart_obj,
            {

              title:{
              text: name
              },
               data: [
              {
                type: "line",

                dataPoints: DataPoints
              }
              ]
            });
            idChart.render();
      });
    }

    function selectAll(id) {
        var select0 = document.getElementById(id);
        for (let i in sorted_ids) {
          var option = document.createElement("OPTION");
          var name = document.createTextNode(sorted_ids[i]);
          option.appendChild(name);
          select0.appendChild(option);
        }
    }

    window.onload = async function () {
      await getIds();
      selectAll('selectopt1');
      selectAll('selectopt0');
    };

    function newChart(id, chart) {
      var chart_obj = document.getElementById(chart);
      var value = document.getElementById(id).value;

      makeChart(value, chart_obj);
    }
</script>
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title">prices of cryptocurrencys</h1>
      <div class="content">
        <p>
          Wähle aus welchen Chart du angezeigt bekommen möchtest. Du kannst auch einen
          zweiten Coin mithinzufügen oder einen neuen Chart erstellen.
        </p>
      </div>
      <div class="level">
        <div class="level left">
          <div class="level-item">
            <div class="select">
              <select id="selectopt0"></select>
            </div>
          </div>
          <div class="level-item">
            <div class="button is-focused is-danger" onclick='newChart("selectopt0", "chartContainer0")'>submit</div>
          </div>
        </div>
        <div class="level right">
          <div class="level-item">
            <div class="select">
              <select id="selectopt1"></select>
            </div>
          </div>
          <div class="level-item">
            <div class="button is-focused is-danger" onclick='newChart("selectopt1", "chartContainer1")'>submit</div>
          </div>
        </div>
      </div>
      <div class="tile is-ancestor">
        <div class="tile is-6">
          <div class="tile is-parent">
            <div class="tile is-child">
            <div id="chartContainer0" style="height: 300px; width: 100%;"></div>
          </div>
        </div>
      </div>
      <div class="tile">
        <div class="tile is-parent">
          <div class="tile is-child">
            <div id="chartContainer1" style="height: 300px; width: 100%;"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="chartContainer" style="height: 400px; width: 100%;"></div>
  </section>
</body>



</html>
